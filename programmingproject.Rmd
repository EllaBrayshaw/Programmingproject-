---
title: "Project"
author: "Ella Brayshaw"
date: "2023-03-07"
output: html_document
---
# MATH5090 - Assignment 2 
## Ella Brayshaw 
## Student number : 201669865

### Introduction
In this report I will be describing and evaluating the BOP2 trial design. I will begin by explaining the key features and steps. Then I will apply the BOP2 method to the reserve trial scenario that we have been provided with. 

We are interested in looking at the progression between stage 1 to stage 2, then from stage 2 to a definitive phase III trial; these progressions are based on the posterior probability of futility. To begin to show the meaning of this idea, I will set $y_i$ to be the number of observations in the $n_i$ particpants ($n_1$ = number of participants in stage 1 and $n_2 = n_1 + \tilde{n_2}$ = participants at the end of stage 2 ). $y_i$ follows a binomial distribution with probability of success, $\theta$, following a  prior beta distribution with parameters $a_0$ and $b_0$.

After observing the response $y_i$ we can then calculate the posterior distribution using Bayes Theorem :  
$$ P(\theta | y_i) = \frac{P(y_i|\theta)*P(\theta)}{P(y_i)} $$
 This results in the posterior probability also following a beta distribution : $P(\theta|y_i)$ ~ beta($a_i$, $b_i$), where $a_i = a + y_i$ and $b_i = b + n_i - y_i$. 
 
We use this posterior probability to determine progression through the probability of futility. We define the probability of futility as the probability of a response, $\theta < 0.5$ given the observed responses : 
$$P(\theta < 0.5 | y_i) $$
We ideally want this probability to be low as the probability of observing a response is poor. To decide whether we carry on to the next stage we need to define a threshold which varies at each stage to compare this too, we define this threshold to be $$C(n_i) = 1 - \lambda(\frac{n_i}{n_2})^{\gamma}$$ In this report we will investigate choices of these stopping rule parameters $\lambda$ and $\gamma$
I defined functions which calculated the probability of futility as well as the thresholds in the Functions. R folder and these can be called by :

```{r}
#source("./R/functions.R")
#probs_futility <- prob_futility(a1, b1, a2, b2) 

#thresholds <- progression_threshold(lambda, gamma, n1, n2)

```






I will now apply the BOP2 trial design to the RESERVE trial. The RESERVE (pREciSion markERs for VEnetoclax in multiple myeloma) trial is a clinical trial which is looking at the effects of treating patients with relapsed/refractory multiple myeloma (RRMM) with Vendex in combination with CyVenDex. The RESERVE trial is currently in phase II and we are wanting to investigate if the treatment has a large enough impact on tumor size to warrant a larger phase III trial. As there is uncertainty to the effectiveness and toxicity of the drug we want to work in 2 stages where the first stage has a lower sample size. This has better ethical, financial and efficiency considerations. In the this report i will be using $n_1$ participants in stage one of the trial and $\tilde{n_2}$ participants in stage 2, this is if we observe enough responses in stage 1 to move onto stage 2. This leads to a total of $n_2 = n_1 + \tilde{n_2}$ participants at the end of stage 2. 

To begin my exploration of the RESERVE trial I wan to find the optimal values of $\lambda$ and $\gamma$ for a fixed $n_1$ and $n_2$ which result in  a type I error rate of at most 0.05 under the null hypothesis of $H_0 : \theta =0.5$ and the type II error rate of at most 0.2 under the alternative hypothesis of $H_1 : \theta = 0.7$. Therefore I will evaluate the type I and type II error rates over a grid of values for $\lambda$ and $\gamma$ and observe which of these have the results we want. For the bounds for the parameters I used the fact that $0\leq \lambda \leq1$ and then a plot to choose $\gamma \ge0$ :


```{r, echo=FALSE,figures-side, fig.show="hold", out.width="50%"}

g<-seq(0,10,length.out = 100)

plot(1-0.3*(0.5)^g, ylab = "Decision threshold", main = "Plot for lambda = 0.3")
abline(v=60, col="magenta")

plot(1-0.7*(0.5)^g, ylab = "Decision threshold", main = "Plot for lambda = 0.7")
abline(v=60, col="magenta")
```

Here I have looked at how the decision threshold, $C(n_i) = 1 - \lambda(\frac{n_i}{n_2})^{\gamma}$, changes for different values of $\gamma$ ( which I created with a sequence ). I chose the value of $\frac{n_i}{n_2}=0.5$, as $n_1 < n_2$ hence the faction will always be less than 1. These plots show that beyond a vale of $\gamma = 6$ there is little change to the value of the decision threshold, $C(n_i)$. Hence I will chose the bound $0\le \gamma \le 6$. I have the created a grid of both the values of $\lambda$ and $\gamma$ over the chosen intervals and have named this "lambda_gamma": 

```{r}
lambda_gamma_seq <- expand.grid(lambda = seq(0, 1, length.out = 50),
                       gamma = seq(0, 6, length.out = 50))
```

I have chosen the length of each vector for the parameter to be 50 as ....

To evaluate the type I and type II error rate over this grid I require to call on a function that I have coded; such functions I have stored in a R script of this R project called "Function.R". Using the command : 

```{r}
source("./R/functions.R")
```

I can easily make use of these functions without having to include the code each time. 

In here is a function called "Type1_exact", which I will now use to evaluate the probability of a type 1 error over the values in "lambda_gamma". A type 1 error is such that we declare a successful trial at the end of stage 2, under the null hypothesis that $\theta = 0.5$. This means that we require $P(\theta < 0.5 | y_1) < C(n_1)$ and $P(\theta < 0.5 | y_1, y_2) < C(n_2)$, we require stage 1 to be successful to move to stage 2 hence both of these are needed. To begin I will set $n_1 = 30$ and $n_2 = 60$. 

```{r}
source("./R/functions.R")
#Type1_prob <- Type1_exact(lambda, gamma, n1, n2)
#evaluate_seq <- evaluate_seq_T1(lambda_gamma_seq, n1, n2)
T1s <- apply(lambda_gamma_seq, 1, evaluate_seq_T1, n1=30, n2=60)
seq_T1s_bind <- cbind(lambda_gamma_seq, T1s)
plot(seq_T1s_bind$lambda,seq_T1s_bind$T1s)
```






